YesWorkflow-NoWorkflow Bridge
=============================

# Overview

The yw-noworkflow repository contains experimental code that explores how the complementary provenance 
information provided by [YesWorkflow](https://github.com/yesworkflow-org/yw-prototypes/tree/master) and [NoWorkflow](https://github.com/gems-uff/noworkflow) can be used together to yield visualizations and 
query results that neither can provide on its own.

# Installation

YesWorkflow-NoWorkflow Bridge requires the installation of both YesWorkflow and NoWorkflow, in order to perform XSB Prolog and SQL queries.

## YesWorkflow

YesWorkflow is a scientific workflow management system that extracts YW commends that users add to scripts that reveal the computational modules and dataflows, render graphical output that reveals the stages of computation and the flow of data in the script, and store the prospective provenance of the data products of scripts. 

YesWorkflow installation details and instructions can be found in [yw-prototype repository](https://github.com/yesworkflow-org/yw-prototypes).

Note that this demonstratiion requires **YesWorkflow 0.2.1**.The latest version of YesWorkflow can be obtained from:
```
    https://opensource.ncsa.illinois.edu/bamboo/browse/KURATOR-YSF/latestSuccessful
```
Click the Artifacts tab, then download the executable jar. The file will be named yesworkflow-0.2.1-SNAPSHOT-jar-with-dependencies.jar. You can also find the executatble jar in the [releases page](https://github.com/idaks/yw-noworkflow/releases).

You may also want to define an alias to simplify running YesWorkflow at the command line.

If you have saved yesworkflow-0.2.1-SNAPSHOT-jar-with-dependencies.jar to the bin subdirectory of your home directory, the following command will create a bash alias for running YesWorkflow simply by typing yw:
```
alias yw='java -jar ~/bin/yesworkflow-0.2.1-SNAPSHOT-jar-with-dependencies.jar'
```
On Windows the command to create the yw macro is:

```
doskey yw=java -jar %USERPROFILE%\bin\yesworkflow-0.2.1-SNAPSHOT-jar-with-dependencies.jar $*
```

## NoWorkflow

NoWorkflow collects provenance for Python scripts into SQLite database. It could show provenance of a trial, compare the collected provenance of different trials, visualize the dataflow, and perform Prolog and SQL queries.

NoWorkflow installation details and instructions can be found in [noWorkflow repository](https://github.com/gems-uff/noworkflow).

## XSB Prolog and SQLite

XSB is a Logic Programming system for Unix and Windows-based platforms. SQLite is a relational database management system contained in a C programming library, and is an embedded SQL database engine. YesWorkflow-NoWorkflow Bridge will use XSB and SQLite to define rules for YesWorkflow, NoWorkflow, and the bridge, and perform queries for them. 

You can find instructions for installing XSB at [XSB Website](http://xsb.sourceforge.net/), or on [the Github page](https://github.com/flavioc/XSB).

Go to [SQLite download page](http://www.sqlite.org/download.html), and download precompiled binaries.

If you are on a Linux or Mac OS X machine, it probably is pre-installed with SQLite. Check if you already have SQLite installed on your machine or not.
```
$ sqlite3
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
sqlite>
```

# Repository organization

Overall sturcture of the repository: 

Directory                                  | Description
-------------------------------------------|------------
./**Docker**                               | Dockerfile and Makefile for Docker image.
./**rules**                                | Rules for yw, nw, yw-nw bridge.
./**scripts**                              | Files that generate views and graphs for examples.
./**examples**                             | Examples that show how to use YesWorkflow-NoWorkflow Bridge.
./examples/**[exampleFolder]**             | Python scripts and output files.
./examples/[exampleFolder]/**csv**         | SQLite facts in CSV.
./examples/[exampleFolder]/**facts**       | Facts that generated by Yesworkflow and NoWorkflow, and views 
./examples/[exampleFolder]/**views**       | Views that generated from facts of Yesworkflow and NoWorkflow.
./examples/[exampleFolder]/**graph**       | Graphs that generated by YesWorkflow, NoWorkflow and Yw-Nw.
./examples/[exampleFolder]/**query**       | Prolog and SQLite queries for Yw, Nw, yw-nw and their output files.

# Usage

We will use simulate_data_collection as an example to show how to use YesWorkflow-NoWorkflow Bridge. simulate_data_collection.py collectes diffraction data from high quality crystals in a cassette. It takes two input files, [cassette_q55_spreadsheet.csv](https://github.com/idaks/yw-noworkflow/blob/master/examples/simulate_data_collection/cassette_q55_spreadsheet.csv) and [calibration.img](https://github.com/idaks/yw-noworkflow/blob/master/examples/simulate_data_collection/calibration.img). The output files are generated in [run](https://github.com/idaks/yw-noworkflow/tree/master/examples/simulate_data_collection/run) folder. 

Go to simulate_data_collection example folder:
```
cd yw-noworkflow/examples/simulate_data_collection/
```

If you would like to reproduce the results through this demo, you can remove all derived files:

```
rm -rf facts graph query/*query_outputs.txt .noworkflow *.txt df_style.py
```

### Example YesWorkflow output

The image below was produced by YesWorkflow using the YW comments added to simulate_data_collection python script ([simulate_data_collection.py](https://github.com/yesworkflow-org/yw-noworkflow/blob/master/examples/simulate_data_collection/simulate_data_collection.py)):

![yw-example](https://github.com/idaks/yw-noworkflow/blob/master/examples/simulate_data_collection/graph/yw_combined_graph.png)

The green blocks represent stages in the computation performed by the script, the yellow blocks represent the input, intermediate, and final data products of the script, and the white blocks are parameters used for the script.

### Example NoWorkflow output

![nw-example](https://github.com/idaks/yw-noworkflow/blob/master/examples/simulate_data_collection/graph/nw_filtered_lineage_graph.png)

The white blocks are input and output data, the dark blue blocks represents computational stages, and blue-green blocks represent parameter names and their values.

### Example Yw-Noworkflow output

![nw-example](https://github.com/idaks/yw-noworkflow/blob/master/examples/simulate_data_collection/graph/yw_nw_retrospective_lineage.png)

## Generate visualizations and query results with Prolog

### Create facts and views from YesWorkflow

- First, create a new folder that will store YesWorkflow facts (and NoWorkflow facts later):

        mkdir facts


- Then run YesWorkflow for the python script `simulate_data_collection.py` marked with YW annotation through command:

    
        java -jar ~/bin/yesworkflow-0.2.1-SNAPSHOT-jar-with-dependencies.jar model simulate_data_collection.py -c extract.language=python -c extract.factsfile=facts/yw_extract_facts.P -c model.factsfile=facts/yw_model_facts.P -c query.engine=xsb


<p style="text-indent: 2em">If you've defined the alias for YesWorkflow, you can simply run:</p>


        yw model simulate_data_collection.py -c extract.language=python -c extract.factsfile=facts/yw_extract_facts.P -c model.factsfile=facts/yw_model_facts.P -c query.engine=xsb


<p style="text-indent: 2em">In this command, `model` means building the workflow model from YW comments in the source script. `extract.language=python` specifies the language used in the source file. `extract.factsfile` and `model.factsfile` specifies the locations to save the facts for the source script and the model. `query.engine=xsb` represents the output query language to be XSB. </p>

<p style="text-indent: 2em">We now get the facts from the YW markup in the source script, and the corresponding models, such as annotations, ports, channels, uri template, etc. You can check these facts in `yw_extract_facts.P` and `yw_model_facts.P` file in `facts` folder.</p>

- Then generate `yw_views` from  the facts:

    `yw_views` are views derived from facts. It organizes the yw facts in such a way that can be reused by our YesWorkflow-NoWorkflow Bridge later, and can be easily queried.


    # We will organize all views in the views folder
        mkdir views

        bash ../../scripts/materialize_yw_views.sh > views/yw_views.P

### Create facts and views from NoWorkflow

- First, run python source script through NoWorkflow:

    now run -e Tracer -d 3 simulate_data_collection.py q55 --cutoff 12 --redundancy 0 > run_outputs.txt

<p style="text-indent: 2em">`now run` specifies the source script to run and collects its provenance. `-e Tracer` tag means NoWorkflow captures variables, dependencies, function calls, parameters, file accesses, and globals. `-d 3` tag represents the depth for capturing function activations is 3, for the sake of the running time. `simulate_data_collection.py q55 --cutoff 12 --redundancy 0` is the source script name and its corresponding input arguments. The output of the script is written to the `run_outputs.txt` file.</p>

    By running NoWorkflow, it automatically creates a SQLite database under .noworkflow folder. We want to extract Prolog facts through NW command `export`:
    
    ```
    now export -t -m dependency | grep -v 'environment(' > facts/nw_facts.P
    ```